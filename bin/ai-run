set -e

TOOL="$1"
shift

WORKSPACES_FILE="$HOME/.ai-workspaces"
CURRENT_DIR="$(pwd)"
ENV_FILE="$HOME/.ai-env"

# Check if workspaces file exists
if [[ ! -f "$WORKSPACES_FILE" ]]; then
  echo "âŒ Workspaces not configured. Run setup.sh first."
  exit 1
fi

# Check if current directory is inside any whitelisted workspace
ALLOWED=false
while IFS= read -r ws; do
  if [[ "$CURRENT_DIR" == "$ws"* ]]; then
    ALLOWED=true
    break
  fi
done < "$WORKSPACES_FILE"

if [[ "$ALLOWED" != "true" ]]; then
  echo "âš ï¸  SECURITY WARNING: You are running $TOOL outside a whitelisted workspace."
  echo "   Current path: $CURRENT_DIR"
  echo ""
  echo "Allowing this path gives the AI container access to this folder."
  read -p "Do you want to whitelist the current directory? [y/N]: " CONFIRM

  if [[ "$CONFIRM" =~ ^[Yy]$ ]]; then
    echo "$CURRENT_DIR" >> "$WORKSPACES_FILE"
    echo "âœ… Added $CURRENT_DIR to $WORKSPACES_FILE"
  else
    echo "âŒ Operation cancelled. Access denied."
    echo "ğŸ“ Allowed workspaces:"
    cat "$WORKSPACES_FILE"
    exit 1
  fi
fi

IMAGE="ai-${TOOL}:latest"

CACHE_DIR="$HOME/.ai-cache/$TOOL"
HOME_DIR="$HOME/.ai-home/$TOOL"

mkdir -p "$CACHE_DIR" "$HOME_DIR"

# Build volume mounts for all whitelisted workspaces
VOLUME_MOUNTS=""
while IFS= read -r ws; do
  VOLUME_MOUNTS="$VOLUME_MOUNTS -v $ws:$ws:delegated"
done < "$WORKSPACES_FILE"

# Tool-specific config mounts (project-level takes precedence over global)
CONFIG_MOUNT=""
PROJECT_CONFIG="$CURRENT_DIR/.$TOOL.json"

if [[ -f "$PROJECT_CONFIG" ]]; then
  # Use project-level config if it exists
  CONFIG_MOUNT="-v $PROJECT_CONFIG:$CURRENT_DIR/.$TOOL.json:delegated"
else
  # Use global configs based on tool
  case "$TOOL" in
    amp)
      CONFIG_DIR="$HOME/.config/amp"
      mkdir -p "$CONFIG_DIR"
      CONFIG_MOUNT="-v $CONFIG_DIR:/home/agent/.config/amp:delegated"
      ;;
    opencode)
      CONFIG_DIR="$HOME/.config/opencode"
      mkdir -p "$CONFIG_DIR"
      CONFIG_MOUNT="-v $CONFIG_DIR:/home/agent/.config/opencode:delegated"
      ;;
    claude)
      CONFIG_DIR="$HOME/.claude"
      mkdir -p "$CONFIG_DIR"
      CONFIG_MOUNT="-v $CONFIG_DIR:/home/agent/.claude:delegated"
      ;;
    droid)
      CONFIG_DIR="$HOME/.config/droid"
      mkdir -p "$CONFIG_DIR"
      CONFIG_MOUNT="-v $CONFIG_DIR:/home/agent/.config/droid:delegated"
      ;;
    qoder)
      CONFIG_DIR="$HOME/.config/qoder"
      mkdir -p "$CONFIG_DIR"
      CONFIG_MOUNT="-v $CONFIG_DIR:/home/agent/.config/qoder:delegated"
      ;;
    auggie)
      CONFIG_DIR="$HOME/.config/auggie"
      mkdir -p "$CONFIG_DIR"
      CONFIG_MOUNT="-v $CONFIG_DIR:/home/agent/.config/auggie:delegated"
      ;;
    codebuddy)
      CONFIG_DIR="$HOME/.config/codebuddy"
      mkdir -p "$CONFIG_DIR"
      CONFIG_MOUNT="-v $CONFIG_DIR:/home/agent/.config/codebuddy:delegated"
      ;;
    jules)
      CONFIG_DIR="$HOME/.config/jules"
      mkdir -p "$CONFIG_DIR"
      CONFIG_MOUNT="-v $CONFIG_DIR:/home/agent/.config/jules:delegated"
      ;;
    shai)
      CONFIG_DIR="$HOME/.config/shai"
      mkdir -p "$CONFIG_DIR"
      CONFIG_MOUNT="-v $CONFIG_DIR:/home/agent/.config/shai:delegated"
      ;;
  esac
fi

# Git access control (opt-in per workspace)
GIT_MOUNTS=""
GIT_ALLOWED_FILE="$HOME/.ai-git-allowed"
touch "$GIT_ALLOWED_FILE"

# Check if Git access is allowed for this workspace
if grep -q "^$CURRENT_DIR$" "$GIT_ALLOWED_FILE" 2>/dev/null; then
  # Previously allowed for this workspace
  if [ -d "$HOME/.ssh" ]; then
    GIT_MOUNTS="$GIT_MOUNTS -v $HOME/.ssh:/home/agent/.ssh:ro"
  fi
  if [ -f "$HOME/.gitconfig" ]; then
    GIT_MOUNTS="$GIT_MOUNTS -v $HOME/.gitconfig:/home/agent/.gitconfig:ro"
  fi
else
  # Ask user if they want Git access for this workspace
  if [ -d "$HOME/.ssh" ] || [ -f "$HOME/.gitconfig" ]; then
    echo ""
    echo "ğŸ” Git Access Control"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "Allow AI tool to access Git credentials for this workspace?"
    echo "Workspace: $CURRENT_DIR"
    echo ""
    echo "  1) Yes, allow once (this session only)"
    echo "  2) Yes, always allow for this workspace"
    echo "  3) No, keep Git disabled (secure default)"
    echo ""
    read -p "Choice [1-3]: " git_choice

    case "$git_choice" in
      1)
        # Allow once
        if [ -d "$HOME/.ssh" ]; then
          GIT_MOUNTS="$GIT_MOUNTS -v $HOME/.ssh:/home/agent/.ssh:ro"
        fi
        if [ -f "$HOME/.gitconfig" ]; then
          GIT_MOUNTS="$GIT_MOUNTS -v $HOME/.gitconfig:/home/agent/.gitconfig:ro"
        fi
        echo "âœ… Git access enabled for this session"
        ;;
      2)
        # Always allow for this workspace
        echo "$CURRENT_DIR" >> "$GIT_ALLOWED_FILE"
        if [ -d "$HOME/.ssh" ]; then
          GIT_MOUNTS="$GIT_MOUNTS -v $HOME/.ssh:/home/agent/.ssh:ro"
        fi
        if [ -f "$HOME/.gitconfig" ]; then
          GIT_MOUNTS="$GIT_MOUNTS -v $HOME/.gitconfig:/home/agent/.gitconfig:ro"
        fi
        echo "âœ… Git access enabled and saved for: $CURRENT_DIR"
        ;;
      *)
        # Default: no Git access
        echo "ğŸ”’ Git access disabled (secure mode)"
        ;;
    esac
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
  fi
fi

docker run --rm -it \
  --platform linux/arm64 \
  $VOLUME_MOUNTS \
  $CONFIG_MOUNT \
  $GIT_MOUNTS \
  -v "$CACHE_DIR":/home/agent/.cache \
  -v "$HOME_DIR":/home/agent \
  -w "$CURRENT_DIR" \
  --env-file "$ENV_FILE" \
  "$IMAGE" "$@"
