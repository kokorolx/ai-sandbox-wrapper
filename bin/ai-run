set -e

TOOL="$1"
shift

WORKSPACES_FILE="$HOME/.ai-workspaces"
CURRENT_DIR="$(pwd)"
ENV_FILE="$HOME/.ai-env"

# Check if workspaces file exists
if [[ ! -f "$WORKSPACES_FILE" ]]; then
  echo "âŒ Workspaces not configured. Run setup.sh first."
  exit 1
fi

# Check if current directory is inside any whitelisted workspace
ALLOWED=false
while IFS= read -r ws; do
  if [[ "$CURRENT_DIR" == "$ws"* ]]; then
    ALLOWED=true
    break
  fi
done < "$WORKSPACES_FILE"

if [[ "$ALLOWED" != "true" ]]; then
  echo "âš ï¸  SECURITY WARNING: You are running $TOOL outside a whitelisted workspace."
  echo "   Current path: $CURRENT_DIR"
  echo ""
  echo "Allowing this path gives the AI container access to this folder."
  read -p "Do you want to whitelist the current directory? [y/N]: " CONFIRM

  if [[ "$CONFIRM" =~ ^[Yy]$ ]]; then
    echo "$CURRENT_DIR" >> "$WORKSPACES_FILE"
    echo "âœ… Added $CURRENT_DIR to $WORKSPACES_FILE"
  else
    echo "âŒ Operation cancelled. Access denied."
    echo "ğŸ“ Allowed workspaces:"
    cat "$WORKSPACES_FILE"
    exit 1
  fi
fi

IMAGE="ai-${TOOL}:latest"

CACHE_DIR="$HOME/.ai-cache/$TOOL"
HOME_DIR="$HOME/.ai-home/$TOOL"

mkdir -p "$CACHE_DIR" "$HOME_DIR"

# Build volume mounts for all whitelisted workspaces
VOLUME_MOUNTS=""
while IFS= read -r ws; do
  VOLUME_MOUNTS="$VOLUME_MOUNTS -v $ws:$ws:delegated"
done < "$WORKSPACES_FILE"

# Tool-specific config mounts (project-level takes precedence over global)
CONFIG_MOUNT=""
PROJECT_CONFIG="$CURRENT_DIR/.$TOOL.json"

if [[ -f "$PROJECT_CONFIG" ]]; then
  # Use project-level config if it exists
  CONFIG_MOUNT="-v $PROJECT_CONFIG:$CURRENT_DIR/.$TOOL.json:delegated"
else
  # Use global configs based on tool
  case "$TOOL" in
    amp)
      CONFIG_DIR="$HOME/.config/amp"
      mkdir -p "$CONFIG_DIR"
      CONFIG_MOUNT="-v $CONFIG_DIR:/home/agent/.config/amp:delegated"
      ;;
    opencode)
      CONFIG_DIR="$HOME/.config/opencode"
      mkdir -p "$CONFIG_DIR"
      CONFIG_MOUNT="-v $CONFIG_DIR:/home/agent/.config/opencode:delegated"
      ;;
    claude)
      CONFIG_DIR="$HOME/.claude"
      mkdir -p "$CONFIG_DIR"
      CONFIG_MOUNT="-v $CONFIG_DIR:/home/agent/.claude:delegated"
      ;;
    droid)
      CONFIG_DIR="$HOME/.config/droid"
      mkdir -p "$CONFIG_DIR"
      CONFIG_MOUNT="-v $CONFIG_DIR:/home/agent/.config/droid:delegated"
      ;;
    qoder)
      CONFIG_DIR="$HOME/.config/qoder"
      mkdir -p "$CONFIG_DIR"
      CONFIG_MOUNT="-v $CONFIG_DIR:/home/agent/.config/qoder:delegated"
      ;;
    auggie)
      CONFIG_DIR="$HOME/.config/auggie"
      mkdir -p "$CONFIG_DIR"
      CONFIG_MOUNT="-v $CONFIG_DIR:/home/agent/.config/auggie:delegated"
      ;;
    codebuddy)
      CONFIG_DIR="$HOME/.config/codebuddy"
      mkdir -p "$CONFIG_DIR"
      CONFIG_MOUNT="-v $CONFIG_DIR:/home/agent/.config/codebuddy:delegated"
      ;;
    jules)
      CONFIG_DIR="$HOME/.config/jules"
      mkdir -p "$CONFIG_DIR"
      CONFIG_MOUNT="-v $CONFIG_DIR:/home/agent/.config/jules:delegated"
      ;;
    shai)
      CONFIG_DIR="$HOME/.config/shai"
      mkdir -p "$CONFIG_DIR"
      CONFIG_MOUNT="-v $CONFIG_DIR:/home/agent/.config/shai:delegated"
      ;;
  esac
fi

# Git access control (opt-in per workspace)
GIT_MOUNTS=""
GIT_ALLOWED_FILE="$HOME/.ai-git-allowed"
GIT_CACHE_DIR="$HOME/.ai-cache/git"
touch "$GIT_ALLOWED_FILE"

# Check if Git access is allowed for this workspace
if grep -q "^$CURRENT_DIR$" "$GIT_ALLOWED_FILE" 2>/dev/null; then
  # Previously allowed for this workspace
  # Check if saved keys exist for this workspace
  WORKSPACE_MD5=$(echo "$CURRENT_DIR" | md5sum | cut -c1-8)
  SAVED_KEYS_FILE="$HOME/.ai-git-keys-$WORKSPACE_MD5"

  if [ -f "$SAVED_KEYS_FILE" ]; then
    # Use previously saved key selection
    echo "ğŸ“‹ Syncing Git credentials..."
    if [ -d "$GIT_CACHE_DIR/ssh" ]; then
      chmod -R 700 "$GIT_CACHE_DIR/ssh" 2>/dev/null || true
      rm -rf "$GIT_CACHE_DIR/ssh"
    fi
    mkdir -p "$GIT_CACHE_DIR/ssh"

    # Read saved keys and copy them
    SAVED_KEYS=()
    while IFS= read -r key; do
      [ -n "$key" ] && SAVED_KEYS+=("$key")
    done < "$SAVED_KEYS_FILE"

    for key in "${SAVED_KEYS[@]}"; do
      [ -z "$key" ] && continue
      src_file="$HOME/.ssh/$key"
      dst_file="$GIT_CACHE_DIR/ssh/$key"

      dst_dir=$(dirname "$dst_file")
      mkdir -p "$dst_dir"
      chmod 700 "$dst_dir"

      if [ -f "$src_file" ]; then
        cp "$src_file" "$dst_file"
        chmod 600 "$dst_file"
      fi
    done

    # Copy filtered SSH config (only hosts needed for this repo)
    if [ -f "$HOME/.ssh/config" ]; then
      SETUP_SSH="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)/setup-ssh-config"
      if [ -x "$SETUP_SSH" ]; then
        # Join SAVED_KEYS into a comma-separated string for --keys
        KEYS_ARG=$(IFS=,; echo "${SAVED_KEYS[*]}")
        output=$("$SETUP_SSH" --keys "$KEYS_ARG" 2>&1)
        TEMP_CONFIG=$(echo "$output" | grep "Config:" | tail -1 | awk '{print $NF}')
        if [ -f "$TEMP_CONFIG" ]; then
          cp "$TEMP_CONFIG" "$GIT_CACHE_DIR/ssh/config"
          chmod 600 "$GIT_CACHE_DIR/ssh/config"
        else
          cp "$HOME/.ssh/config" "$GIT_CACHE_DIR/ssh/config"
          chmod 600 "$GIT_CACHE_DIR/ssh/config"
        fi
      else
        cp "$HOME/.ssh/config" "$GIT_CACHE_DIR/ssh/config"
        chmod 600 "$GIT_CACHE_DIR/ssh/config"
      fi
    fi

    if [ -f "$HOME/.ssh/known_hosts" ]; then
      cp "$HOME/.ssh/known_hosts" "$GIT_CACHE_DIR/ssh/known_hosts"
      chmod 600 "$GIT_CACHE_DIR/ssh/known_hosts"
    fi

    # Ensure all directories have correct permissions (recursive)
    chmod 700 "$GIT_CACHE_DIR/ssh"
    find "$GIT_CACHE_DIR/ssh" -type d -exec chmod 700 {} \;
    find "$GIT_CACHE_DIR/ssh" -type f ! -name "config" ! -name "known_hosts" -exec chmod 600 {} \;

    GIT_MOUNTS="$GIT_MOUNTS -v $GIT_CACHE_DIR/ssh:/home/agent/.ssh:ro"
    echo "âœ… Git credentials synced"
  fi

  if [ -f "$HOME/.gitconfig" ]; then
    # Copy gitconfig to HOME_DIR (can't mount file inside mounted directory)
    cp "$HOME/.gitconfig" "$HOME_DIR/.gitconfig" 2>/dev/null || true
  fi
else
  # Ask user if they want Git access for this workspace
  if [ -d "$HOME/.ssh" ] || [ -f "$HOME/.gitconfig" ]; then
    echo ""
    echo "ğŸ” Git Access Control"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "Allow AI tool to access Git credentials for this workspace?"
    echo "Workspace: $CURRENT_DIR"
    echo ""
    echo "  1) Yes, allow once (this session only)"
    echo "  2) Yes, always allow for this workspace"
    echo "  3) No, keep Git disabled (secure default)"
    echo ""
    read -p "Choice [1-3]: " git_choice

    case "$git_choice" in
      1|2)
        # Interactive SSH key selection
        echo ""
        echo "ğŸ”‘ SSH Key Selection"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

        # Source the SSH key selector library
        # Resolve symlink to get actual project directory
        SCRIPT_PATH="${BASH_SOURCE[0]}"
        while [ -L "$SCRIPT_PATH" ]; do
          SCRIPT_DIR="$(cd "$(dirname "$SCRIPT_PATH")" && pwd)"
          SCRIPT_PATH="$(readlink "$SCRIPT_PATH")"
          [[ $SCRIPT_PATH != /* ]] && SCRIPT_PATH="$SCRIPT_DIR/$SCRIPT_PATH"
        done
        SCRIPT_DIR="$(cd "$(dirname "$SCRIPT_PATH")" && pwd)"
        source "$SCRIPT_DIR/../lib/ssh-key-selector.sh"

        # Let user select keys
        if select_ssh_keys; then
          if [ ${#SELECTED_SSH_KEYS[@]} -gt 0 ]; then
            echo "ğŸ“‹ Copying selected credentials to cache..."
            if [ -d "$GIT_CACHE_DIR/ssh" ]; then
              chmod -R 700 "$GIT_CACHE_DIR/ssh" 2>/dev/null || true
              rm -rf "$GIT_CACHE_DIR/ssh"
            fi
            mkdir -p "$GIT_CACHE_DIR/ssh"

            # Copy selected SSH keys (preserve directory structure exactly)
            for key in "${SELECTED_SSH_KEYS[@]}"; do
              echo "  â†’ Copying $key..."
              src_file="$HOME/.ssh/$key"
              dst_file="$GIT_CACHE_DIR/ssh/$key"

              # Create parent directory with correct permissions
              dst_dir=$(dirname "$dst_file")
              mkdir -p "$dst_dir"
              chmod 700 "$dst_dir"

              # Copy the file and set permissions
              if [ -f "$src_file" ]; then
                cp "$src_file" "$dst_file"
                chmod 600 "$dst_file"
              else
                echo "    âš ï¸  Warning: $src_file not found, skipping"
              fi
            done

            # Copy filtered SSH config (only hosts needed for this repo)
            if [ -f "$HOME/.ssh/config" ]; then
              echo "  â†’ Generating filtered SSH config..."
              # Run setup-ssh-config to get filtered config
              SETUP_SSH="$SCRIPT_DIR/setup-ssh-config"
              if [ -x "$SETUP_SSH" ]; then
                # Join SELECTED_SSH_KEYS into a comma-separated string for --keys
                KEYS_ARG=$(IFS=,; echo "${SELECTED_SSH_KEYS[*]}")
                # Run it and capture the filtered config path
                output=$("$SETUP_SSH" --keys "$KEYS_ARG" 2>&1)
                TEMP_CONFIG=$(echo "$output" | grep "Config:" | tail -1 | awk '{print $NF}')
                if [ -f "$TEMP_CONFIG" ]; then
                  cp "$TEMP_CONFIG" "$GIT_CACHE_DIR/ssh/config"
                  chmod 600 "$GIT_CACHE_DIR/ssh/config"
                else
                  # Fallback to copying full config if setup-ssh-config fails
                  cp "$HOME/.ssh/config" "$GIT_CACHE_DIR/ssh/config"
                  chmod 600 "$GIT_CACHE_DIR/ssh/config"
                fi
              else
                # Fallback: copy full config
                cp "$HOME/.ssh/config" "$GIT_CACHE_DIR/ssh/config"
                chmod 600 "$GIT_CACHE_DIR/ssh/config"
              fi
            fi

            if [ -f "$HOME/.ssh/known_hosts" ]; then
              echo "  â†’ Copying known_hosts..."
              cp "$HOME/.ssh/known_hosts" "$GIT_CACHE_DIR/ssh/known_hosts"
              chmod 600 "$GIT_CACHE_DIR/ssh/known_hosts"
            fi

            # Ensure all directories and files have correct permissions (recursive)
            chmod 700 "$GIT_CACHE_DIR/ssh"
            find "$GIT_CACHE_DIR/ssh" -type d -exec chmod 700 {} \;
            find "$GIT_CACHE_DIR/ssh" -type f ! -name "config" ! -name "known_hosts" -exec chmod 600 {} \;

            GIT_MOUNTS="$GIT_MOUNTS -v $GIT_CACHE_DIR/ssh:/home/agent/.ssh:ro"

            # Copy gitconfig
            if [ -f "$HOME/.gitconfig" ]; then
              echo "  â†’ Copying .gitconfig..."
              cp "$HOME/.gitconfig" "$HOME_DIR/.gitconfig" 2>/dev/null || true
            fi

            if [ "$git_choice" = "2" ]; then
              # Save workspace and selected keys for future sessions
              echo "$CURRENT_DIR" >> "$GIT_ALLOWED_FILE"
              # Save selected keys (one per line for easier parsing)
              WORKSPACE_MD5=$(echo "$CURRENT_DIR" | md5sum | cut -c1-8)
              printf "%s\n" "${SELECTED_SSH_KEYS[@]}" > "$HOME/.ai-git-keys-$WORKSPACE_MD5"
              echo "âœ… Git access enabled and saved for: $CURRENT_DIR"
            else
              echo "âœ… Git access enabled for this session"
            fi
          else
            echo "âš ï¸  No SSH keys selected. Git access disabled."
          fi
        else
          echo "âš ï¸  SSH key selection cancelled. Git access disabled."
        fi
        ;;
      *)
        # Default: no Git access
        echo "ğŸ”’ Git access disabled (secure mode)"
        ;;
    esac
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
  fi
fi

docker run --rm -it \
  --platform linux/arm64 \
  $VOLUME_MOUNTS \
  $CONFIG_MOUNT \
  $GIT_MOUNTS \
  -v "$CACHE_DIR":/home/agent/.cache \
  -v "$HOME_DIR":/home/agent \
  -w "$CURRENT_DIR" \
  --env-file "$ENV_FILE" \
  "$IMAGE" "$@"
