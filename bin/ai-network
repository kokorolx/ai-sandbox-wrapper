#!/usr/bin/env bash
# Network management helper for AI Sandbox Wrapper
# Usage: ai-network <command> [network-name]
#
# Commands:
#   list          List configured networks
#   add <name>    Add a network to join
#   remove <name> Remove a network
#   check <name>  Check if network exists
#   metamcp       Quick command to add MetaMCP network

set -e

NETWORK_FILE="$HOME/.ai-networks"
COMMAND="${1:-list}"

# Ensure network file exists
touch "$NETWORK_FILE"

list_networks() {
  echo "üìã Configured Networks:"
  echo ""
  if [[ -s "$NETWORK_FILE" ]]; then
    while IFS= read -r network; do
      if [[ -n "$network" ]]; then
        if docker network inspect "$network" >/dev/null 2>&1; then
          echo "  ‚úÖ $network"
        else
          echo "  ‚ùå $network (not found)"
        fi
      fi
    done < "$NETWORK_FILE"
  else
    echo "  No networks configured."
    echo ""
    echo "  To add a network:"
    echo "    ai-network add <network-name>"
  fi
}

add_network() {
  local network_name="$2"
  
  if [[ -z "$network_name" ]]; then
    echo "‚ùå Error: Network name required"
    echo "   Usage: ai-network add <network-name>"
    exit 1
  fi
  
  # Check if network exists
  if ! docker network inspect "$network_name" >/dev/null 2>&1; then
    echo "‚ö†Ô∏è  Network '$network_name' does not exist yet."
    read -p "Add it anyway? [y/N]: " confirm
    if [[ ! "$confirm" =~ ^[Yy]$ ]]; then
      exit 0
    fi
  fi
  
  # Add to config (avoid duplicates)
  if grep -q "^${network_name}$" "$NETWORK_FILE" 2>/dev/null; then
    echo "‚úÖ Network '$network_name' already configured"
  else
    echo "$network_name" >> "$NETWORK_FILE"
    chmod 600 "$NETWORK_FILE"
    echo "‚úÖ Added network: $network_name"
  fi
}

remove_network() {
  local network_name="$2"
  
  if [[ -z "$network_name" ]]; then
    echo "‚ùå Error: Network name required"
    echo "   Usage: ai-network remove <network-name>"
    exit 1
  fi
  
  if grep -q "^${network_name}$" "$NETWORK_FILE" 2>/dev/null; then
    # Remove the network from file
    grep -v "^${network_name}$" "$NETWORK_FILE" > "$NETWORK_FILE.tmp"
    mv "$NETWORK_FILE.tmp" "$NETWORK_FILE"
    chmod 600 "$NETWORK_FILE"
    echo "‚úÖ Removed network: $network_name"
  else
    echo "‚ö†Ô∏è  Network '$network_name' not found in config"
  fi
}

check_network() {
  local network_name="${2:-metamcp_metamcp-network}"
  
  if docker network inspect "$network_name" >/dev/null 2>&1; then
    echo "‚úÖ Network '$network_name' exists"
    return 0
  else
    echo "‚ùå Network '$network_name' not found"
    return 1
  fi
}

add_metamcp() {
  echo "üîó Adding MetaMCP network..."
  add_network "metamcp_metamcp-network"
}

case "$COMMAND" in
  list)
    list_networks
    ;;
  add)
    add_network "$@"
    ;;
  remove|rm|delete)
    remove_network "$@"
    ;;
  check)
    check_network "$@"
    ;;
  metamcp|meta)
    add_metamcp
    ;;
  help|--help|-h)
    echo "AI Network Manager"
    echo ""
    echo "Usage: ai-network <command> [network-name]"
    echo ""
    echo "Commands:"
    echo "  list              Show all configured networks"
    echo "  add <name>        Add a Docker network"
    echo "  remove <name>     Remove a configured network"
    echo "  check [name]      Check if a network exists"
    echo "  metamcp           Quick-add MetaMCP network"
    echo ""
    echo "Examples:"
    echo "  ai-network list"
    echo "  ai-network add my-network"
    echo "  ai-network metamcp"
    ;;
  *)
    echo "Unknown command: $COMMAND"
    echo "Run 'ai-network help' for usage"
    exit 1
    ;;
esac
