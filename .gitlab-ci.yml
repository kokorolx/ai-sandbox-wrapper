variables:
  DOCKER_HOST: tcp://docker:2375
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: ""

stages:
  - build-base
  - build-tools

services:
  - name: docker:24.0.5-dind
    alias: docker
    command: ["--tls=false"]

before_script:
  - apk add --no-cache bash curl
  - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" "$CI_REGISTRY"

.build_template:
  image: docker:24.0.5
  script:
    - TOOL_NAME=$TOOL_NAME
    - IMAGE_TAG=$CI_REGISTRY_IMAGE/ai-$TOOL_NAME:latest
    - echo "Preparing base image..."
    - docker pull $CI_REGISTRY_IMAGE/ai-base:latest
    - docker tag $CI_REGISTRY_IMAGE/ai-base:latest ai-base:latest
    - echo "Building image $IMAGE_TAG..."
    - bash lib/install-$TOOL_NAME.sh
    # We need to tag the image properly before pushing,
    # but install scripts tag as ai-$TOOL:latest locally.
    - docker tag ai-$TOOL_NAME:latest $IMAGE_TAG
    - echo "Verifying tool works..."
    - |
      set +e
      docker run --rm $IMAGE_TAG $TOOL_NAME --version 2>&1 | head -5
      VERSION_EXIT=$?
      if [ $VERSION_EXIT -ne 0 ]; then
        echo "Trying --help instead..."
        docker run --rm $IMAGE_TAG $TOOL_NAME --help 2>&1 | head -10
        HELP_EXIT=$?
        if [ $HELP_EXIT -ne 0 ]; then
          echo "ERROR: Tool verification failed! Binary may not be in PATH or is broken."
          exit 1
        fi
      fi
      set -e
    - echo "Verification passed! Pushing image..."
    - docker push $IMAGE_TAG
  needs:
    - optional: true
      job: build_base

build_base:
  stage: build-base
  image: docker:24.0.5
  script:
    - echo "Building base image..."
    - bash lib/install-base.sh
    - docker tag ai-base:latest $CI_REGISTRY_IMAGE/ai-base:latest
    - docker push $CI_REGISTRY_IMAGE/ai-base:latest
  rules:
    - if: '$CI_PIPELINE_SOURCE == "web"'
      when: manual
    - changes:
        - lib/install-base.sh
        - dockerfiles/base/Dockerfile
      when: always
    - when: never

build_amp:
  stage: build-tools
  extends: .build_template
  variables:
    TOOL_NAME: amp

build_droid:
  stage: build-tools
  extends: .build_template
  variables:
    TOOL_NAME: droid

build_claude:
  stage: build-tools
  extends: .build_template
  variables:
    TOOL_NAME: claude

build_opencode:
  stage: build-tools
  extends: .build_template
  variables:
    TOOL_NAME: opencode

build_gemini:
  stage: build-tools
  extends: .build_template
  variables:
    TOOL_NAME: gemini

build_kilo:
  stage: build-tools
  extends: .build_template
  variables:
    TOOL_NAME: kilo

build_qwen:
  stage: build-tools
  extends: .build_template
  variables:
    TOOL_NAME: qwen

build_codex:
  stage: build-tools
  extends: .build_template
  variables:
    TOOL_NAME: codex

build_aider:
  stage: build-tools
  extends: .build_template
  variables:
    TOOL_NAME: aider
