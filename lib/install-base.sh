#!/usr/bin/env bash
set -e

# Build base Docker image with Bun runtime (2x faster than Node.js)
mkdir -p "dockerfiles/base"

ADDITIONAL_TOOLS_INSTALL=""

if [[ "${INSTALL_SPEC_KIT:-0}" -eq 1 ]]; then
  echo "ðŸ“¦ spec-kit will be installed in base image"
  ADDITIONAL_TOOLS_INSTALL+='RUN pipx install specify-cli --pip-args="git+https://github.com/github/spec-kit.git"
'
fi

if [[ "${INSTALL_UX_UI_PROMAX:-0}" -eq 1 ]]; then
  echo "ðŸ“¦ ux-ui-promax will be installed in base image"
  ADDITIONAL_TOOLS_INSTALL+='RUN bun install -g uipro-cli
'
fi

if [[ "${INSTALL_OPENSPEC:-0}" -eq 1 ]]; then
  echo "ðŸ“¦ OpenSpec will be installed in base image"
  ADDITIONAL_TOOLS_INSTALL+='RUN mkdir -p /usr/local/lib/openspec && \
    cd /usr/local/lib/openspec && \
    bun init -y && \
    bun add @fission-ai/openspec && \
    ln -sf /usr/local/lib/openspec/node_modules/.bin/openspec /usr/local/bin/openspec
'
fi

if [[ "${INSTALL_PLAYWRIGHT:-0}" -eq 1 ]]; then
  echo "ðŸ“¦ Playwright will be installed in base image"
  ADDITIONAL_TOOLS_INSTALL+='# Install Playwright system dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    libglib2.0-0 \
    libnspr4 \
    libnss3 \
    libdbus-1-3 \
    libatk1.0-0 \
    libatk-bridge2.0-0 \
    libcups2 \
    libxcb1 \
    libxkbcommon0 \
    libatspi2.0-0 \
    libx11-6 \
    libxcomposite1 \
    libxdamage1 \
    libxext6 \
    libxfixes3 \
    libxrandr2 \
    libgbm1 \
    libcairo2 \
    libpango-1.0-0 \
    libasound2 \
    && rm -rf /var/lib/apt/lists/*
# Install Playwright and browsers via npm (avoids pnpm global bin issues)
RUN npm install -g playwright && npx playwright install
'
fi

if [[ "${INSTALL_RUBY:-0}" -eq 1 ]]; then
  echo "ðŸ“¦ Ruby 3.3.0 + Rails 8.0.2 will be installed in base image"
  ADDITIONAL_TOOLS_INSTALL+='RUN apt-get update && apt-get install -y --no-install-recommends \
    libssl-dev \
    libreadline-dev \
    zlib1g-dev \
    libyaml-dev \
    libffi-dev \
    libgdbm-dev \
    libncurses5-dev \
    libpq-dev \
    default-libmysqlclient-dev \
    libsqlite3-dev \
    imagemagick \
    libmagickwand-dev \
    libvips-dev \
    autoconf \
    bison \
    rustc \
    libxml2-dev \
    libxslt1-dev \
    && rm -rf /var/lib/apt/lists/*

RUN git clone https://github.com/rbenv/rbenv.git /usr/local/rbenv && \
    git clone https://github.com/rbenv/ruby-build.git /usr/local/rbenv/plugins/ruby-build

ENV RBENV_ROOT=/usr/local/rbenv
ENV PATH=$RBENV_ROOT/bin:$RBENV_ROOT/shims:$PATH

RUN rbenv install 3.3.0 && rbenv global 3.3.0 && rbenv rehash

RUN gem install rails -v 8.0.2 && gem install bundler && rbenv rehash
'
fi

cat > "dockerfiles/base/Dockerfile" <<EOF
FROM oven/bun:latest

# Install common dependencies (Bun + Node.js + Python for full package manager support)
RUN apt-get update && apt-get install -y --no-install-recommends \\
    git \\
    curl \\
    ssh \\
    ca-certificates \\
    python3 \\
    python3-pip \\
    python3-venv \\
    python3-dev \\
    python3-setuptools \\
    build-essential \\
    libopenblas-dev \\
    pipx \\
    && curl -LsSf https://astral.sh/uv/install.sh | UV_INSTALL_DIR=/usr/local/bin sh \\
    && rm -rf /var/lib/apt/lists/* \\
    && pipx ensurepath

# Install Node.js LTS (includes npm) via NodeSource
RUN curl -fsSL https://deb.nodesource.com/setup_lts.x | bash - \\
    && apt-get install -y nodejs \\
    && rm -rf /var/lib/apt/lists/*

# Install pnpm globally via npm
RUN npm install -g pnpm

# Install TypeScript and LSP tools for AI coding assistants
RUN npm install -g typescript typescript-language-server

# Verify installations
RUN node --version && npm --version && pnpm --version && bun --version && tsc --version

# Install additional tools (if selected)
${ADDITIONAL_TOOLS_INSTALL}
# Create workspace
WORKDIR /workspace

# Non-root user for security
RUN useradd -m -u 1001 -d /home/agent agent && \\
    chown -R agent:agent /workspace
USER agent
ENV HOME=/home/agent
EOF

echo "Building base Docker image with Bun runtime..."
docker build -t "ai-base:latest" "dockerfiles/base"
echo "âœ… Base image built (ai-base:latest)"

